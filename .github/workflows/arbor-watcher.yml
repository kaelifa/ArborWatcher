name: Arbor Watcher (Scheduled)

on:
  workflow_dispatch:
  schedule:
    # Every hour at minute 7 (tweak to taste)
    - cron: "7 * * * *"

permissions:
  contents: read

concurrency:
  group: arbor-watcher
  cancel-in-progress: false

jobs:
  run-watcher:
    runs-on: ubuntu-latest
    timeout-minutes: 10

    env:
      # App config from repo or defaults
      ORIGIN: https://the-castle-school.uk.arbor.education
      STATE_FILE: /home/runner/work/_temp/arborwatcher_state.json
      PYTHONUNBUFFERED: "1"
      PIP_DISABLE_PIP_VERSION_CHECK: "1"
      CI: "true" # lets the script default to headless if you add that logic later

      # Secrets (set these in repo Settings → Secrets and variables → Actions)
      ARBOR_EMAIL: ${{ secrets.ARBOR_EMAIL }}
      ARBOR_PASSWORD: ${{ secrets.ARBOR_PASSWORD }}
      ARBOR_STUDENT_ID: ${{ secrets.ARBOR_STUDENT_ID }} # e.g. 5739
      TELEGRAM_TOKEN: ${{ secrets.TELEGRAM_TOKEN }}
      TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"

      - name: Install Python deps
        run: |
          python -m pip install --upgrade pip wheel
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
          # Ensure Playwright is available
          pip install playwright
          python -m playwright install --with-deps chromium

      - name: Run watcher (headless)
        id: watcher
        run: |
          echo "Running watcher headless on $ORIGIN for student $ARBOR_STUDENT_ID"
          python3 monitor_arbor_portal.py --headless --fast || echo "::set-output name=failed::true"

      # If the run failed, try to gather any debug files you emit via --debug-dump
      - name: Re-run with debug dump on failure
        if: steps.watcher.outputs.failed == 'true'
        run: |
          echo "First run failed. Re-running with --debug-dump for artefacts…"
          python3 monitor_arbor_portal.py --headless --fast --debug-dump || true

      - name: Upload debug artefacts (if present)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: arborwatcher-debug-${{ github.run_id }}
          path: |
            **/dump_*.* 
            **/*.html
            **/*.png
          if-no-files-found: ignore
