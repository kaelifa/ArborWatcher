name: Arbor Watcher Test

on:
  workflow_dispatch:   # manual trigger only

permissions:
  contents: read

jobs:
  test-run:
    runs-on: ubuntu-latest
    timeout-minutes: 5
    env:
      ORIGIN: https://the-castle-school.uk.arbor.education
      ARBOR_EMAIL: ${{ secrets.ARBOR_EMAIL }}
      ARBOR_PASSWORD: ${{ secrets.ARBOR_PASSWORD }}
      ARBOR_STUDENT_ID: ${{ secrets.ARBOR_STUDENT_ID }}
      TELEGRAM_TOKEN: ${{ secrets.TELEGRAM_TOKEN }}
      TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"

      - name: Install deps
        run: |
          python -m pip install --upgrade pip wheel
          pip install playwright
          python -m playwright install --with-deps chromium

      - name: Quick login check
        run: |
          echo "Attempting login to $ORIGIN..."
          python3 - <<'PYCODE'
import os, sys
from playwright.sync_api import sync_playwright
email=os.environ['ARBOR_EMAIL']; pw=os.environ['ARBOR_PASSWORD']; origin=os.environ['ORIGIN']
with sync_playwright() as p:
    browser = p.chromium.launch(headless=True)
    page = browser.new_page()
    page.goto(origin, timeout=60000)
    page.locator('input[type=email]').fill(email)
    page.locator('input[type=password]').fill(pw)
    page.locator('button[type=submit]').click()
    page.wait_for_timeout(5000)
    print("✅ Logged in OK. Page title:", page.title())
    browser.close()
PYCODE

      - name: Telegram ping
        run: |
          curl -s "https://api.telegram.org/bot${{ secrets.TELEGRAM_TOKEN }}/sendMessage" \
            -d chat_id="${{ secrets.TELEGRAM_CHAT_ID }}" \
            -d text="✅ Arbor Watcher test passed successfully at $(date -u +"%Y-%m-%d %H:%M:%S") UTC"